import express from "express";
import axios from "axios";
import http from "http";
import { Server } from "socket.io";
import cors from "cors";

const API_KEY = "EC5j4KH1v6QNhTVlcCRZ2dvhQgXccMf5";
const PORT = 3000;

const app = express();
app.use(cors());
app.use(express.static("public"));

const server = http.createServer(app);
const io = new Server(server);

let sessionId = null;

async function getSessionId() {
    const res = await axios.get(
        `https://api.infiniteflight.com/public/v2/sessions?apikey=${EC5j4KH1v6QNhTVlcCRZ2dvhQgXccMf5}`
    );

    const expert = res.data.result.find(s =>
        s.name === "Expert Server"
    );

    sessionId = expert?.id;
    console.log("Expert Session ID:", sessionId);
}

async function fetchFlights() {
    if (!sessionId) return;

    try {
        const res = await axios.get(
            `https://api.infiniteflight.com/public/v2/sessions/${sessionId}/flights?apikey=${EC5j4KH1v6QNhTVlcCRZ2dvhQgXccMf5}`
        );

        const flights = res.data.result;

        const slFlights = flights
            .filter(f => f.callsign?.endsWith("SL"))
            .map(f => ({
                callsign: f.callsign,
                latitude: f.latitude,
                longitude: f.longitude,
                altitude: Math.round(f.altitude),
                speed: Math.round(f.speed),
                heading: f.heading,
                departure: f.departureAirportId,
                arrival: f.arrivalAirportId
            }));

        io.emit("updateFlights", slFlights);

    } catch (err) {
        console.log("Flight fetch error:", err.message);
    }
}

io.on("connection", socket => {
    console.log("Client connected");
});

server.listen(PORT, async () => {
    console.log(`Server running on http://localhost:${PORT}`);
    await getSessionId();
    setInterval(fetchFlights, 20000); // 20 saniye
});
